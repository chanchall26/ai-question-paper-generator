<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Intelligent Paper Generator</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* --- Color variables & themes --- */
    :root{
      --primary-color:#00796b;
      --accent-color:#ffab40;
      --bg:#f5f7fa;
      --card:#ffffff;
      --text:#334155;
      --muted:#64748b;
      --border:#e2e8f0;
      --shadow: rgba(100,116,139,0.12);
      --easy:#22c55e;
      --med:#3b82f6;
      --hard:#ef4444;
    }

    [data-bs-theme="dark"]{
      --primary-color:#26a69a;
      --accent-color:#ffd180;
      --bg:#0f172a;
      --card:#1e293b;
      --text:#cbd5e1;
      --muted:#94a3b8;
      --border:#334155;
      --shadow: rgba(0,0,0,0.2);
      --easy:#4ade80;
      --med:#60a5fa;
      --hard:#f87171;
    }

    html,body{ 
        height:100%; 
        background:var(--bg); 
        color:var(--text); 
        font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; 
        overflow-x: hidden; /* Prevent horizontal scroll from decorative blobs */
    }
    
    .main-container { position: relative; }

    /* --- NEW --- Decorative Background Blobs */
    body::before,
    body::after {
        content: '';
        position: fixed;
        z-index: -1;
        border-radius: 50%;
        filter: blur(100px);
        will-change: transform;
    }

    body::before {
        background-color: var(--primary-color);
        width: 350px;
        height: 350px;
        top: -100px;
        left: -150px;
        opacity: 0.15;
    }

    body::after {
        background-color: var(--accent-color);
        width: 300px;
        height: 300px;
        bottom: -120px;
        right: -100px;
        opacity: 0.1;
    }
    /* --- END NEW --- */


    /* Cards & layout */
    .main-card, .offcanvas { background:var(--card); border:1px solid var(--border); color: var(--text); }
    .main-card { border-radius:16px; box-shadow:0 6px 16px -8px var(--shadow), 0 6px 12px -12px var(--shadow); }
    .card-header { background:transparent; border-bottom:1px solid var(--border); padding:1rem 1.25rem; }
    .card-body { padding:1.5rem; }
    .offcanvas-header { border-bottom: 1px solid var(--border); }

    /* Form steps */
    .form-step { display:none; animation:fadeIn .25s ease-out; }
    .form-step.active { display:block; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(6px); } to { opacity:1; transform: none; } }

    .form-label { font-weight:600; color:var(--muted); font-size:0.95rem; }
    .form-control, .form-select { border-radius:8px; background:var(--bg); border:1px solid var(--border); padding:10px 12px; font-weight:600; color:var(--text); }
    .form-control::placeholder { color: var(--muted); font-weight:500; }
    .form-control.is-invalid { border-color: #dc3545; }


    .btn { border-radius:10px; font-weight:700; }
    .btn-primary { background:var(--primary-color); border:none; color:#fff; }
    .btn-primary:hover { background-color: #005a4f; }
    .btn-outline-secondary { border-color: var(--border); color: var(--muted); }
    .btn-outline-secondary:hover { background-color: var(--border); color: var(--text); }
    .btn-success { background-color: #198754; border-color: #198754; }

    .progress { height:10px; border-radius:6px; background:var(--border); }
    .progress-bar { background:var(--accent-color); transition:width .35s ease-in-out; }

    /* Distribution bar */
    .distribution-bar { position:relative; width:100%; height:20px; background:var(--border); border-radius:10px; display:flex; overflow:hidden; }
    .dist-segment { height:100%; } /* Removed transition for smoother dragging */
    .dist-segment.easy { background:var(--easy); }
    .dist-segment.medium { background:var(--med); }
    .dist-segment.hard { background:var(--hard); }
    .dist-handle { position:absolute; top:50%; transform:translate(-50%,-50%); width:24px; height:24px; border-radius:50%; background:var(--card); border:3px solid var(--primary-color); cursor:ew-resize; z-index:10; }
    .dist-labels { display:flex; justify-content:space-between; margin-top:8px; }

    .question-type-group { padding:12px; border-radius:8px; border:1px solid var(--border); }
    #chaptersContainer { max-height:220px; overflow-y:auto; border:1px solid var(--border); border-radius:10px; padding:10px; background:var(--bg); }
    
    #toolbar { position: absolute; top: 0; left: 0; }
    .paper-history-card { border: 1px solid var(--border); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; }
    
    /* Dark Mode Overrides */
    [data-bs-theme="dark"] .form-control,
    [data-bs-theme="dark"] .form-select,
    [data-bs-theme="dark"] #chaptersContainer,
    [data-bs-theme="dark"] .offcanvas {
      background-color: var(--bg) !important;
      border-color: var(--border) !important;
      color: var(--text) !important;
    }
    [data-bs-theme="dark"] .offcanvas { background-image: none; }
    [data-bs-theme="dark"] .btn-outline-secondary { color: var(--text) !important; border-color: var(--border) !important; }
    [data-bs-theme="dark"] .list-group-item { background-color: transparent !important; border-color: var(--border) !important;}
    [data-bs-theme="dark"] .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
  </style>
</head>
<body>
  
  <div class="position-fixed top-0 end-0 p-3" style="z-index:1050;">
      <div class="d-flex align-items-center gap-2">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-outline-secondary active" id="langEn">EN</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="langHi">हिं</button>
        </div>
        <div class="form-check form-switch">
            <input id="darkModeToggle" class="form-check-input" type="checkbox" role="switch" />
            <label class="form-check-label" for="darkModeToggle"><i class="bi bi-moon-stars-fill"></i></label>
        </div>
      </div>
  </div>

  <div class="container my-5 main-container">

    <div id="toolbar">
        <button class="btn btn-outline-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#papersOffcanvas" aria-controls="papersOffcanvas">
            <i class="bi bi-journals me-1"></i> <span data-lang-key="generatedPapers">Generated Papers</span>
        </button>
    </div>
    
    <div class="text-center mb-5">
      <h1 class="display-5 fw-bold" data-lang-key="title">Intelligent Paper Generator</h1>
      <p class="lead" style="color:var(--muted)" data-lang-key="subtitle">Build assessments quickly.</p>
    </div>

    <div class="row g-5">
      <div class="col-lg-10 col-xl-8 mx-auto">
        <div class="main-card">
          <div class="card-header">
            <div class="progress"><div id="progressBar" class="progress-bar" role="progressbar" style="width:0%"></div></div>
          </div>

          <div class="card-body">
            <form id="paperGeneratorForm" novalidate>
              <div class="form-step active" id="step1">
                <h4 class="mb-4 fw-bold" data-lang-key="step1Title">Step 1: Core Details</h4>
                 <div class="mb-4">
                    <label class="form-label" data-lang-key="generationMode">Generation Mode</label>
                    <div class="btn-group d-flex" role="group">
                        <button type="button" class="btn btn-outline-secondary" id="modeTopicBtn" data-lang-key="byTopic">By Topic</button>
                        <button type="button" class="btn btn-primary" id="modeClassBtn" data-lang-key="byClassAndChapters">By Class & Chapters</button>
                    </div>
                </div>
                
                <div class="row g-3">
                  <div class="col-md-6">
                      <label for="schoolBoard" class="form-label" data-lang-key="schoolBoard">School Board</label>
                      <select class="form-select" id="schoolBoard" required>
                          <option value="" data-lang-key="selectBoard">Select Board...</option>
                          <option value="CBSE">CBSE</option>
                          <option value="ICSE">ICSE</option>
                          <option value="State Board">State Board</option>
                      </select>
                  </div>
                  <div class="col-md-6">
                      <label for="paperLanguage" class="form-label" data-lang-key="paperLanguage">Paper Language</label>
                      <select class="form-select" id="paperLanguage">
                          <option value="english">English</option>
                          <option value="hindi">Hindi</option>
                      </select>
                  </div>

                  <div class="col-12" id="topicField" style="display: none;">
                      <label for="topic" class="form-label" data-lang-key="topic">Topic</label>
                      <input type="text" class="form-control" id="topic" placeholder="e.g., Photosynthesis, Indian History">
                  </div>

                  <div class="col-md-6" id="classField">
                      <label for="classSelect" class="form-label" data-lang-key="class">Class</label>
                      <select class="form-select" id="classSelect" required>
                           <option value="" data-lang-key="selectClass">Select Class...</option>
                      </select>
                  </div>
                  <div class="col-md-6" id="subjectField">
                      <label for="subjectSelect" class="form-label" data-lang-key="subject">Subject</label>
                      <select class="form-select" id="subjectSelect" required>
                          <option value="" data-lang-key="selectSubject">Select Subject...</option>
                      </select>
                  </div>
                  <div class="col-12" id="chaptersField">
                    <label class="form-label" data-lang-key="chapters">Select Chapters (<span data-lang-key="optional">Optional</span>)</label>
                    <div class="mb-2 d-flex gap-2">
                      <button type="button" id="selectAllChapters" class="btn btn-sm btn-outline-primary" disabled><i class="bi bi-check2-square me-1"></i><span data-lang-key="selectAll">Select All</span></button>
                      <button type="button" id="deselectAllChapters" class="btn btn-sm btn-outline-secondary" disabled><i class="bi bi-x-square me-1"></i><span data-lang-key="deselectAll">Deselect All</span></button>
                    </div>
                    <div id="chaptersContainer">
                      <small class="text-muted" data-lang-key="selectClassSubjectPrompt">Please select a board, class and subject to see chapters.</small>
                    </div>
                  </div>
                </div>

                <div class="d-flex justify-content-end mt-4">
                  <button type="button" class="btn btn-primary next-btn"><span data-lang-key="next">Next</span> <i class="bi bi-arrow-right ms-1"></i></button>
                </div>
              </div>

              <div class="form-step" id="step2">
                <h4 class="mb-4 fw-bold" data-lang-key="step2Title">Step 2: Questions & Difficulty</h4>
                <div class="row g-3" id="questionTypesContainer">
                    </div>
                
                <div class="d-flex justify-content-end mt-3">
                    <div class="p-2 fw-bold" style="background-color: var(--border); border-radius: 8px;">
                        <span data-lang-key="totalMarks">Total Marks</span>: <span id="step2TotalMarks">0</span>
                    </div>
                </div>

                 <hr class="my-4">
                 <div>
                    <label class="form-label fw-bold" data-lang-key="difficultyDistribution">Difficulty Distribution</label>
                     <div class="distribution-bar-container">
                      <div class="dist-labels">
                        <div class="dist-label text-success"><span data-lang-key="easy">Easy</span>: <span class="badge text-bg-success" id="easyValueEl">40%</span></div>
                        <div class="dist-label text-primary"><span data-lang-key="medium">Medium</span>: <span class="badge text-bg-primary" id="medValueEl">40%</span></div>
                        <div class="dist-label text-danger"><span data-lang-key="hard">Hard</span>: <span class="badge text-bg-danger" id="hardValueEl">20%</span></div>
                      </div>
                      <div class="distribution-bar mt-2" id="distributionBar">
                        <div class="dist-segment easy" id="easySeg"></div>
                        <div class="dist-segment medium" id="medSeg"></div>
                        <div class="dist-segment hard" id="hardSeg"></div>
                        <div class="dist-handle" id="handle1" style="left:40%"></div>
                        <div class="dist-handle" id="handle2" style="left:80%"></div>
                      </div>
                    </div>
                 </div>
                <div class="d-flex justify-content-between mt-4">
                  <button type="button" class="btn btn-outline-secondary prev-btn"><i class="bi bi-arrow-left me-1"></i><span data-lang-key="previous">Previous</span></button>
                  <button type="button" class="btn btn-primary next-btn"><span data-lang-key="next">Next</span> <i class="bi bi-arrow-right ms-1"></i></button>
                </div>
              </div>

              <div class="form-step" id="step3">
                <h4 class="mb-4 fw-bold" data-lang-key="step3Title">Step 3: Final Details</h4>
                 <div class="row g-4">
                    <div class="col-md-6">
                        <label for="examName" class="form-label">
                            <span data-lang-key="examName">Examination Name</span> 
                            <span class="text-muted" data-lang-key="optional">(Optional)</span>
                        </label>
                        <input type="text" class="form-control" id="examName" placeholder="e.g., Mid-Term Exam">
                    </div>
                    <div class="col-md-6">
                        <label for="schoolName" class="form-label">
                            <span data-lang-key="schoolName">School Name</span> 
                            <span class="text-muted" data-lang-key="optional">(Optional)</span>
                        </label>
                        <input type="text" class="form-control" id="schoolName" placeholder="e.g., Delhi Public School">
                    </div>
                </div>
                
                <div class="border rounded p-3 my-4" id="finalPreviewBox">
                    <h5 data-lang-key="finalPreview">Final Preview</h5>
                    <div id="finalPreviewContent" class="text-muted small mt-2"></div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                  <button type="button" class="btn btn-outline-secondary prev-btn"><i class="bi bi-arrow-left me-1"></i><span data-lang-key="previous">Previous</span></button>
                  <button type="button" id="generatePaperBtn" class="btn btn-success"><i class="bi bi-stars me-1"></i><span data-lang-key="generatePaper">Generate Paper</span></button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="offcanvas offcanvas-start" tabindex="-1" id="papersOffcanvas" aria-labelledby="papersOffcanvasLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="papersOffcanvasLabel" data-lang-key="generatedPapers">Generated Papers</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body" id="generatedPapersContainer">
        </div>
    </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- STATE ---
        let currentStep = 0;
        let generationMode = 'class';

        // --- DATA ---
        const subjects = {
            CBSE: {
                1: [{en:'English',hi:'अंग्रेजी'},{en:'Hindi',hi:'हिन्दी'},{en:'Mathematics',hi:'गणित'},{en:'EVS',hi:'ईवीएस'}],
                2: [{en:'English',hi:'अंग्रेजी'},{en:'Hindi',hi:'हिन्दी'},{en:'Mathematics',hi:'गणित'},{en:'EVS',hi:'ईवीएस'}],
                3: [{en:'English',hi:'अंग्रेजी'},{en:'Hindi',hi:'हिन्दी'},{en:'Mathematics',hi:'गणित'},{en:'Science',hi:'विज्ञान'}],
                4: [{en:'English',hi:'अंग्रेजी'},{en:'Hindi',hi:'हिन्दी'},{en:'Mathematics',hi:'गणित'},{en:'Science',hi:'विज्ञान'}],
                5: [{en:'English',hi:'अंग्रेजी'},{en:'Hindi',hi:'हिन्दी'},{en:'Mathematics',hi:'गणित'},{en:'Science',hi:'विज्ञान'}],
                6: [{en:'English',hi:'अंग्रेजी'},{en:'Hindi',hi:'हिन्दी'},{en:'Mathematics',hi:'गणित'},{en:'Science',hi:'विज्ञान'},{en:'Social Science',hi:'सामाजिक विज्ञान'}],
                7: [{en:'English',hi:'अंग्रेजी'},{en:'Hindi',hi:'हिन्दी'},{en:'Mathematics',hi:'गणित'},{en:'Science',hi:'विज्ञान'},{en:'Social Science',hi:'सामाजिक विज्ञान'}],
                8: [{en:'English',hi:'अंग्रेजी'},{en:'Hindi',hi:'हिन्दी'},{en:'Mathematics',hi:'गणित'},{en:'Science',hi:'विज्ञान'},{en:'Social Science',hi:'सामाजिक विज्ञान'}],
                9: [{en:'English',hi:'अंग्रेजी'},{en:'Hindi',hi:'हिन्दी'},{en:'Mathematics',hi:'गणित'},{en:'Science',hi:'विज्ञान'},{en:'Social Science',hi:'सामाजिक विज्ञान'},{en:'Computer Science',hi:'कंप्यूटर विज्ञान'}],
                10: [{en:'English',hi:'अंग्रेजी'},{en:'Hindi',hi:'हिन्दी'},{en:'Mathematics',hi:'गणित'},{en:'Science',hi:'विज्ञान'},{en:'Social Science',hi:'सामाजिक विज्ञान'},{en:'Computer Science',hi:'कंप्यूटर विज्ञान'}],
                11: [{en:'English',hi:'अंग्रेजी'},{en:'Physics',hi:'भौतिक विज्ञान'},{en:'Chemistry',hi:'रसायन विज्ञान'},{en:'Mathematics',hi:'गणित'},{en:'Biology',hi:'जीव विज्ञान'},{en:'Economics',hi:'अर्थशास्त्र'},{en:'Accountancy',hi:'लेखाकर्म'},{en:'Computer Science',hi:'कंप्यूटर विज्ञान'}],
                12: [{en:'English',hi:'अंग्रेजी'},{en:'Physics',hi:'भौतिक विज्ञान'},{en:'Chemistry',hi:'रसायन विज्ञान'},{en:'Mathematics',hi:'गणित'},{en:'Biology',hi:'जीव विज्ञान'},{en:'Economics',hi:'अर्थशास्त्र'},{en:'Accountancy',hi:'लेखाकर्म'},{en:'Computer Science',hi:'कंप्यूटर विज्ञान'}]
            },
            ICSE: {
                1: [{en:'English',hi:'अंग्रेजी'},{en:'Environmental Studies',hi:'पर्यावरण अध्ययन'}],
                2: [{en:'English',hi:'अंग्रेजी'},{en:'Environmental Studies',hi:'पर्यावरण अध्ययन'}],
                3: [{en:'English',hi:'अंग्रेजी'},{en:'Mathematics',hi:'गणित'},{en:'Environmental Studies',hi:'पर्यावरण अध्ययन'}],
                4: [{en:'English',hi:'अंग्रेजी'},{en:'Mathematics',hi:'गणित'},{en:'Environmental Studies',hi:'पर्यावरण अध्ययन'}],
                5: [{en:'English',hi:'अंग्रेजी'},{en:'Mathematics',hi:'गणित'},{en:'Environmental Studies',hi:'पर्यावरण अध्ययन'}],
                6: [{en:'English',hi:'अंग्रेजी'},{en:'Mathematics',hi:'गणित'},{en:'Science',hi:'विज्ञान'},{en:'Social Science',hi:'सामाजिक विज्ञान'}],
                7: [{en:'English',hi:'अंग्रेजी'},{en:'Mathematics',hi:'गणित'},{en:'Science',hi:'विज्ञान'},{en:'Social Science',hi:'सामाजिक विज्ञान'}],
                8: [{en:'English',hi:'अंग्रेजी'},{en:'Mathematics',hi:'गणित'},{en:'Science',hi:'विज्ञान'},{en:'Social Science',hi:'सामाजिक विज्ञान'}],
                9: [{en:'Mathematics',hi:'गणित'},{en:'English',hi:'अंग्रेजी'},{en:'Physics',hi:'भौतिक विज्ञान'},{en:'Chemistry',hi:'रसायन विज्ञान'},{en:'Biology',hi:'जीव विज्ञान'},{en:'History & Civics',hi:'इतिहास और नागरिक शास्त्र'},{en:'Geography',hi:'भूगोल'},{en:'Computer',hi:'कंप्यूटर'},{en:'English Grammar',hi:'अंग्रेजी व्याकरण'}],
                10: [{en:'Mathematics',hi:'गणित'},{en:'English',hi:'अंग्रेजी'},{en:'Physics',hi:'भौतिक विज्ञान'},{en:'Chemistry',hi:'रसायन विज्ञान'},{en:'Biology',hi:'जीव विज्ञान'},{en:'History & Civics',hi:'इतिहास और नागरिक शास्त्र'},{en:'Geography',hi:'भूगोल'},{en:'Computer',hi:'कंप्यूटर'},{en:'English Grammar',hi:'अंग्रेजी व्याकरण'}],
                11: [{en:'English',hi:'अंग्रेजी'},{en:'Physics',hi:'भौतिक विज्ञान'},{en:'Chemistry',hi:'रसायन विज्ञान'},{en:'Mathematics',hi:'गणित'},{en:'Biology',hi:'जीव विज्ञान'},{en:'Economics',hi:'अर्थशास्त्र'},{en:'Accountancy',hi:'लेखाकर्म'},{en:'Computer Science',hi:'कंप्यूटर विज्ञान'}],
                12: [{en:'English',hi:'अंग्रेजी'},{en:'Physics',hi:'भौतिक विज्ञान'},{en:'Chemistry',hi:'रसायन विज्ञान'},{en:'Mathematics',hi:'गणित'},{en:'Biology',hi:'जीव विज्ञान'},{en:'Economics',hi:'अर्थशास्त्र'},{en:'Accountancy',hi:'लेखाकर्म'},{en:'Computer Science',hi:'कंप्यूटर विज्ञान'}]
            },
            "State Board": {
                1: [{en:'English',hi:'अंग्रेजी'},{en:'Regional Language',hi:'क्षेत्रीय भाषा'}],
                2: [{en:'English',hi:'अंग्रेजी'},{en:'Regional Language',hi:'क्षेत्रीय भाषा'}],
                3: [{en:'English',hi:'अंग्रेजी'},{en:'Mathematics',hi:'गणित'},{en:'Science',hi:'विज्ञान'}],
                4: [{en:'English',hi:'अंग्रेजी'},{en:'Mathematics',hi:'गणित'},{en:'Science',hi:'विज्ञान'}],
                5: [{en:'English',hi:'अंग्रेजी'},{en:'Mathematics',hi:'गणित'},{en:'Science',hi:'विज्ञान'}],
                6: [{en:'English',hi:'अंग्रेजी'},{en:'Hindi',hi:'हिन्दी'},{en:'Mathematics',hi:'गणित'},{en:'Science',hi:'विज्ञान'},{en:'Social Science',hi:'सामाजिक विज्ञान'}],
                7: [{en:'English',hi:'अंग्रेजी'},{en:'Hindi',hi:'हिन्दी'},{en:'Mathematics',hi:'गणित'},{en:'Science',hi:'विज्ञान'},{en:'Social Science',hi:'सामाजिक विज्ञान'}],
                8: [{en:'English',hi:'अंग्रेजी'},{en:'Hindi',hi:'हिन्दी'},{en:'Mathematics',hi:'गणित'},{en:'Science',hi:'विज्ञान'},{en:'Social Science',hi:'सामाजिक विज्ञान'}],
                9: [{en:'English',hi:'अंग्रेजी'},{en:'Hindi',hi:'हिन्दी'},{en:'Mathematics',hi:'गणित'},{en:'Science',hi:'विज्ञान'},{en:'Social Science',hi:'सामाजिक विज्ञान'},{en:'Computer Science',hi:'कंप्यूटर विज्ञान'}],
                10: [{en:'English',hi:'अंग्रेजी'},{en:'Hindi',hi:'हिन्दी'},{en:'Mathematics',hi:'गणित'},{en:'Science',hi:'विज्ञान'},{en:'Social Science',hi:'सामाजिक विज्ञान'},{en:'Computer Science',hi:'कंप्यूटर विज्ञान'}],
                11: [{en:'English',hi:'अंग्रेजी'},{en:'Physics',hi:'भौतिक विज्ञान'},{en:'Chemistry',hi:'रसायन विज्ञान'},{en:'Mathematics',hi:'गणित'},{en:'Biology',hi:'जीव विज्ञान'},{en:'Economics',hi:'अर्थशास्त्र'},{en:'Accountancy',hi:'लेखाकर्म'},{en:'Computer Science',hi:'कंप्यूटर विज्ञान'}],
                12: [{en:'English',hi:'अंग्रेजी'},{en:'Physics',hi:'भौतिक विज्ञान'},{en:'Chemistry',hi:'रसायन विज्ञान'},{en:'Mathematics',hi:'गणित'},{en:'Biology',hi:'जीव विज्ञान'},{en:'Economics',hi:'अर्थशास्त्र'},{en:'Accountancy',hi:'लेखाकर्म'},{en:'Computer Science',hi:'कंप्यूटर विज्ञान'}]
            }
        };
        const chaptersData = {
            CBSE: {
                10: {
                    Science: ["Chemical Reactions", "Acids, Bases and Salts", "Life Processes"],
                    Mathematics: ["Real Numbers", "Polynomials", "Triangles"]
                }
            }
        };
        const questionTypes = [
            { id: 'MCQ', labelKey: 'mcq', defaultMarks: 1 }, { id: 'Fill', labelKey: 'fillInBlanks', defaultMarks: 1 },
            { id: 'Short', labelKey: 'shortAnswer', defaultMarks: 3 }, { id: 'Long', labelKey: 'longAnswer', defaultMarks: 5 },
            { id: 'Match', labelKey: 'matching', defaultMarks: 4 }, { id: 'Case', labelKey: 'caseStudy', defaultMarks: 5 }
        ];
        const langData = { en: {title: "Intelligent Paper Generator", subtitle: "Build assessments quickly.", generatedPapers: "Generated Papers", finalPreview: "Final Preview", step1Title: "Step 1: Core Details", generationMode: "Generation Mode", byTopic: "By Topic", byClassAndChapters: "By Class & Chapters", schoolBoard: "School Board", selectBoard: "Select Board...", paperLanguage: "Paper Language", topic: "Topic", class: "Class", selectClass: "Select Class...", subject: "Subject", selectSubject: "Select Subject...", chapters: "Chapters", selectAll: "Select All", deselectAll: "Deselect All", selectClassSubjectPrompt: "Please select a board, class and subject.", next: "Next", previous: "Previous", step2Title: "Step 2: Questions & Difficulty", mcq: "Multiple Choice", fillInBlanks: "Fill in the Blanks", shortAnswer: "Short Answer", longAnswer: "Long Answer", matching: "Matching", caseStudy: "Case Study", marks: "Marks", difficultyDistribution: "Difficulty Distribution", questions: "Questions", totalMarks: "Total Marks", step3Title: "Step 3: Final Details", examName: "Examination Name", schoolName: "School Name", optional: "(Optional)", generatePaper: "Generate Paper", easy: "Easy", medium: "Medium", hard: "Hard", noPapers: "No papers generated yet.", downloadPaper: "Download Paper", downloadAnswers: "Download Answers"}, hi: { title: "इंटेलिजेंट पेपर जेनरेटर", subtitle: "आसानी से मूल्यांकन बनाएं।", generatedPapers: "जेनरेट किए गए पेपर", finalPreview: "अंतिम पूर्वावलोकन", step1Title: "चरण 1: मुख्य विवरण", generationMode: "जनरेशन मोड", byTopic: "विषय के अनुसार", byClassAndChapters: "कक्षा और अध्याय के अनुसार", schoolBoard: "स्कूल बोर्ड", selectBoard: "बोर्ड चुनें...", paperLanguage: "पेपर की भाषा", topic: "विषय", class: "कक्षा", selectClass: "कक्षा चुनें...", subject: "विषय", selectSubject: "विषय चुनें...", chapters: "अध्याय", selectAll: "सभी चुनें", deselectAll: "सभी अचयनित करें", selectClassSubjectPrompt: "कृपया बोर्ड, कक्षा और विषय चुनें।", next: "अगला", previous: "पिछला", step2Title: "चरण 2: प्रश्न और कठिनाई", mcq: "बहुविकल्पीय", fillInBlanks: "रिक्त स्थान भरें", shortAnswer: "लघु उत्तरीय", longAnswer: "दीर्घ उत्तरीय", matching: "मिलान", caseStudy: "केस स्टडी", marks: "अंक", difficultyDistribution: "कठिनाई वितरण", questions: "प्रश्न", totalMarks: "कुल अंक", step3Title: "चरण 3: अंतिम विवरण", examName: "परीक्षा का नाम", schoolName: "स्कूल का नाम", optional: "(वैकल्पिक)", generatePaper: "पेपर जेनरेट करें", easy: "आसान", medium: "मध्यम", hard: "कठिन", noPapers: "अभी तक कोई पेपर नहीं बनाया गया है।", downloadPaper: "पेपर डाउनलोड करें", downloadAnswers: "उत्तर कुंजी डाउनलोड करें" }};

        // --- DOM ELEMENTS ---
        const steps = Array.from(document.querySelectorAll('.form-step'));
        const progressBar = document.getElementById('progressBar');
        const [modeTopicBtn, modeClassBtn] = [document.getElementById('modeTopicBtn'), document.getElementById('modeClassBtn')];
        const classRelatedFields = ['classField', 'subjectField', 'chaptersField'].map(id => document.getElementById(id));
        const topicField = document.getElementById('topicField');
        const [schoolBoard, classSelect, subjectSelect, chaptersContainer, topicInput, examName, schoolName] = [document.getElementById('schoolBoard'), document.getElementById('classSelect'), document.getElementById('subjectSelect'), document.getElementById('chaptersContainer'), document.getElementById('topic'), document.getElementById('examName'), document.getElementById('schoolName')];
        const [selectAllChaptersBtn, deselectAllChaptersBtn] = [document.getElementById('selectAllChapters'), document.getElementById('deselectAllChapters')];
        const qTypesContainer = document.getElementById('questionTypesContainer');
        const [handle1, handle2, easySeg, medSeg, hardSeg, easyValueEl, medValueEl, hardValueEl] = [document.getElementById('handle1'), document.getElementById('handle2'), document.getElementById('easySeg'), document.getElementById('medSeg'), document.getElementById('hardSeg'), document.getElementById('easyValueEl'), document.getElementById('medValueEl'), document.getElementById('hardValueEl')];
        const [darkModeToggle, langEnBtn, langHiBtn] = [document.getElementById('darkModeToggle'), document.getElementById('langEn'), document.getElementById('langHi')];
        const generatedPapersContainer = document.getElementById('generatedPapersContainer');
        const finalPreviewContent = document.getElementById('finalPreviewContent');
        const step2TotalMarks = document.getElementById('step2TotalMarks');

        // --- FUNCTIONS ---
        const getLangText = key => langData[document.documentElement.lang || 'en'][key] || key;
        
        const showStep = (idx) => {
            if (idx > currentStep && !validateStep(currentStep)) return;
            steps.forEach((s, i) => s.classList.toggle('active', i === idx));
            currentStep = idx;
            progressBar.style.width = (currentStep / (steps.length - 1)) * 100 + '%';
            if (idx === 2) {
                updateFinalPreview();
            }
        };

        const validateStep = (idx) => {
            const stepEl = steps[idx];
            const requireds = stepEl.querySelectorAll('input[required]:not(:disabled), select[required]:not(:disabled)');
            let ok = true;
            requireds.forEach(el => {
                if (!el.value || el.value === '') {
                    el.classList.add('is-invalid');
                    ok = false;
                } else {
                    el.classList.remove('is-invalid');
                }
            });
            return ok;
        };
        
        const setGenerationMode = (mode) => {
            generationMode = mode;
            const isTopic = mode === 'topic';
            modeTopicBtn.classList.toggle('btn-primary', isTopic);
            modeTopicBtn.classList.toggle('btn-outline-secondary', !isTopic);
            modeClassBtn.classList.toggle('btn-primary', !isTopic);
            modeClassBtn.classList.toggle('btn-outline-secondary', isTopic);
            
            topicField.style.display = isTopic ? 'block' : 'none';
            topicInput.required = isTopic;
            topicInput.disabled = !isTopic;
            
            classRelatedFields.forEach(field => field.style.display = isTopic ? 'none' : 'block');
            [classSelect, subjectSelect].forEach(el => { el.required = !isTopic; el.disabled = isTopic; });
        };

        const populateClasses = () => {
            classSelect.innerHTML = `<option value="">${getLangText('selectClass')}</option>`;
            for (let i = 1; i <= 12; i++) {
                classSelect.add(new Option(i, i));
            }
        };

        const populateSubjects = () => {
            const board = schoolBoard.value;
            const cls = classSelect.value;
            const currentSubjectValue = subjectSelect.value;
            const currentLang = document.documentElement.lang || 'en';
            subjectSelect.innerHTML = `<option value="">${getLangText('selectSubject')}</option>`;
            clearChapters();
            if (board && cls && subjects[board] && subjects[board][cls]) {
                subjects[board][cls].forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.en;
                    option.textContent = subject[currentLang] || subject.en;
                    subjectSelect.appendChild(option);
                });
            }
            subjectSelect.value = currentSubjectValue;
        };

        const populateChapters = () => {
            const board = schoolBoard.value;
            const cls = classSelect.value;
            const subj = subjectSelect.value;
            clearChapters();
            const chapters = chaptersData?.[board]?.[cls]?.[subj] || [];
            if (!chapters.length) {
                clearChapters('No chapters available for this selection.');
                return;
            }
            chapters.forEach((ch, idx) => {
                const div = document.createElement('div');
                div.className = 'form-check';
                div.innerHTML = `<input class="form-check-input chapter-checkbox" type="checkbox" id="chap-${idx}" value="${ch}"><label class="form-check-label" for="chap-${idx}">${ch}</label>`;
                chaptersContainer.appendChild(div);
            });
            selectAllChaptersBtn.disabled = false;
            deselectAllChaptersBtn.disabled = false;
        };

        const clearChapters = (msg = getLangText('selectClassSubjectPrompt')) => {
            chaptersContainer.innerHTML = `<small class="text-muted">${msg}</small>`;
            selectAllChaptersBtn.disabled = true;
            deselectAllChaptersBtn.disabled = true;
        };

        const updateFinalPreview = () => {
            const data = buildPayload();
            let html = '<ul class="list-unstyled">';
            
            if(data.mode === 'class') {
                html += `<li><strong>${getLangText('schoolBoard')}:</strong> ${data.board}</li>`;
                html += `<li><strong>${getLangText('class')}:</strong> ${data.class}</li>`;
                html += `<li><strong>${getLangText('subject')}:</strong> ${data.subject_hi}</li>`;
                html += `<li><strong>${getLangText('chapters')}:</strong> ${data.chapters.length > 0 ? data.chapters.join(', ') : 'All'}</li>`;
            } else {
                html += `<li><strong>${getLangText('topic')}:</strong> ${data.topic}</li>`;
            }
            html += `<hr class="my-2">`;
            html += `<li><strong>${getLangText('totalMarks')}:</strong> ${data.totals.marks}</li>`;
            html += `<li><strong>${getLangText('questions')}:</strong> ${data.totals.questions}</li>`;
            html += `</ul>`;

            finalPreviewContent.innerHTML = html;
        };

        const switchLanguage = (lang) => {
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                el.textContent = getLangText(el.dataset.langKey);
            });
            langHiBtn.classList.toggle('active', lang === 'hi');
            langEnBtn.classList.toggle('active', lang === 'en');
            populateSubjects();
            updateDistribution();
            injectQuestionTypes();
            renderGeneratedPapers();
            updateStep2Totals();
        };

        // --- SLIDER LOGIC ---
        let activeHandle = null;

        function updateDistribution() {
            const p1 = parseFloat(handle1.style.left);
            const p2 = parseFloat(handle2.style.left);
            const easyPercent = Math.round(p1);
            const medPercent = Math.round(p2 - p1);
            const hardPercent = 100 - easyPercent - medPercent;
            
            easySeg.style.width = easyPercent + '%';
            medSeg.style.width = medPercent + '%';
            hardSeg.style.width = hardPercent + '%';
            
            easyValueEl.textContent = easyPercent + '%';
            medValueEl.textContent = medPercent + '%';
            hardValueEl.textContent = hardPercent + '%';
        }

        const onMouseMove = (moveEvent) => {
            if (!activeHandle) return;

            const rect = document.getElementById('distributionBar').getBoundingClientRect();
            let percent = ((moveEvent.clientX - rect.left) / rect.width) * 100;
            percent = Math.max(0, Math.min(100, percent));

            if (activeHandle.id === 'handle1') {
                const rightLimit = parseFloat(handle2.style.left);
                percent = Math.min(percent, rightLimit);
            } else { 
                const leftLimit = parseFloat(handle1.style.left);
                percent = Math.max(percent, leftLimit);
            }

            activeHandle.style.left = percent + '%';
            updateDistribution();
        };

        const onMouseUp = () => {
            if (!activeHandle) return;
            document.body.style.cursor = 'default';
            activeHandle = null;
        };
        
        function activateHandle(handle, event) {
            event.preventDefault();
            document.body.style.cursor = 'ew-resize';
            activeHandle = handle;
        }
        
        handle1.addEventListener('mousedown', (e) => activateHandle(handle1, e));
        handle2.addEventListener('mousedown', (e) => activateHandle(handle2, e));
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        
        const updateStep2Totals = () => {
            let totalM = 0;
            qTypesContainer.querySelectorAll('.question-type-group').forEach(group => {
                const count = parseInt(group.querySelector('.question-count').value) || 0;
                const marks = parseInt(group.querySelector('.marks-per-question').value) || 0;
                totalM += count * marks;
            });
            step2TotalMarks.textContent = totalM;
        };

        function injectQuestionTypes() {
            const values = {};
            qTypesContainer.querySelectorAll('.question-count').forEach((el, idx) => { values[idx] = el.value });

            qTypesContainer.innerHTML = questionTypes.map((q, idx) => `
              <div class="col-md-6 question-type-group">
                <label class="form-label fw-bold">${getLangText(q.labelKey)}</label>
                <div class="row g-2">
                  <div class="col-6">
                    <div class="input-group">
                      <span class="input-group-text">#</span>
                      <input type="number" class="form-control question-count" value="${values[idx] || 0}" min="0" required>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="input-group">
                      <span class="input-group-text">${getLangText('marks')}</span>
                      <input type="number" class="form-control marks-per-question" value="${q.defaultMarks}" min="1" required>
                    </div>
                  </div>
                </div>
              </div>
            `).join('');
        }

        function savePaper() {
            const paperData = buildPayload();
            let papers = JSON.parse(localStorage.getItem('generatedPapers') || '[]');
            papers.unshift(paperData);
            localStorage.setItem('generatedPapers', JSON.stringify(papers));
            alert('Paper Generated and Saved!');
            renderGeneratedPapers();
        }

        function buildPayload() {
            const payload = {
                id: Date.now(),
                mode: generationMode,
                examName: examName.value || 'Untitled Exam',
                schoolName: schoolName.value,
                board: schoolBoard.value,
                paperLang: document.getElementById('paperLanguage').value,
                questionTypes: {},
                difficulty: {}
            };

            if (generationMode === 'topic') {
                payload.topic = topicInput.value;
            } else {
                payload.class = classSelect.value;
                payload.subject = subjectSelect.value;
                payload.subject_hi = subjectSelect.options[subjectSelect.selectedIndex]?.textContent || subjectSelect.value;
                payload.chapters = Array.from(chaptersContainer.querySelectorAll('.chapter-checkbox:checked')).map(cb => cb.value);
            }
            
            let totalQ = 0, totalM = 0;
            qTypesContainer.querySelectorAll('.question-type-group').forEach(group => {
                const label = group.querySelector('.form-label').textContent;
                const count = parseInt(group.querySelector('.question-count').value) || 0;
                const marks = parseInt(group.querySelector('.marks-per-question').value) || 0;
                if(count > 0) payload.questionTypes[label] = { count, marks };
                totalQ += count;
                totalM += count * marks;
            });
            payload.totals = { questions: totalQ, marks: totalM };

            payload.difficulty = { easy: easyValueEl.textContent, medium: medValueEl.textContent, hard: hardValueEl.textContent };
            return payload;
        }
        
        function renderGeneratedPapers() {
            const papers = JSON.parse(localStorage.getItem('generatedPapers') || '[]');
            if (papers.length === 0) {
                generatedPapersContainer.innerHTML = `<p class="text-muted">${getLangText('noPapers')}</p>`;
                return;
            }

            generatedPapersContainer.innerHTML = papers.map(paper => {
                 const subjectDisplay = document.documentElement.lang === 'hi' ? paper.subject_hi : paper.subject;
                 return `
                <div class="paper-history-card">
                    <h6 class="fw-bold">${paper.examName}</h6>
                    <p class="mb-1 small">
                        ${paper.mode === 'topic' ? `<strong>${getLangText('topic')}:</strong> ${paper.topic}` : `<strong>${getLangText('class')}:</strong> ${paper.class} | <strong>${getLangText('subject')}:</strong> ${subjectDisplay}`}
                    </p>
                    <p class="mb-2 small"><strong>${getLangText('questions')}:</strong> ${paper.totals.questions} | <strong>${getLangText('totalMarks')}:</strong> ${paper.totals.marks}</p>
                    <div class="d-flex gap-2">
                         <button class="btn btn-sm btn-outline-primary download-paper-btn" data-id="${paper.id}">${getLangText('downloadPaper')}</button>
                         <button class="btn btn-sm btn-outline-success download-answers-btn" data-id="${paper.id}">${getLangText('downloadAnswers')}</button>
                    </div>
                </div>
            `}).join('');
        }

        function downloadAsTextFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleDownload(paperId, type) {
            const papers = JSON.parse(localStorage.getItem('generatedPapers') || '[]');
            const paper = papers.find(p => p.id == paperId);
            if (!paper) return;

            let content = ``;
            let filename = ``;

            if (type === 'paper') {
                content += `PAPER SUMMARY\n====================\n`;
                content += `Exam Name: ${paper.examName}\n`;
                content += `School: ${paper.schoolName || 'N/A'}\n`;
                if(paper.mode === 'class') {
                    content += `Board: ${paper.board}\nClass: ${paper.class}\nSubject: ${paper.subject}\n`;
                    content += `Chapters: ${paper.chapters.length > 0 ? paper.chapters.join(', ') : 'All'}\n`;
                } else {
                    content += `Topic: ${paper.topic}\n`;
                }
                content += `\nTotal Questions: ${paper.totals.questions}\nTotal Marks: ${paper.totals.marks}\n`;
                content += `\nQUESTION DISTRIBUTION:\n`;
                for(const [q, details] of Object.entries(paper.questionTypes)) {
                    content += `- ${q}: ${details.count} questions, ${details.marks} marks each\n`;
                }
                filename = `${paper.examName.replace(/\s+/g, '_')}_Paper.txt`;
            } else { // Answer Key
                content += `ANSWER KEY\n====================\n`;
                content += `Exam Name: ${paper.examName}\n\n`;
                let qNum = 1;
                for(const [q, details] of Object.entries(paper.questionTypes)) {
                    for(let i=0; i<details.count; i++) {
                         content += `Q${qNum++} (${q}): [Placeholder Answer]\n`;
                    }
                }
                filename = `${paper.examName.replace(/\s+/g, '_')}_AnswerKey.txt`;
            }

            downloadAsTextFile(content, filename);
        }


        // --- EVENT LISTENERS ---
        document.addEventListener('click', (e) => {
            if (e.target.closest('.next-btn')) showStep(currentStep + 1);
            if (e.target.closest('.prev-btn')) showStep(currentStep - 1);
            if (e.target.closest('.download-paper-btn')) handleDownload(e.target.dataset.id, 'paper');
            if (e.target.closest('.download-answers-btn')) handleDownload(e.target.dataset.id, 'answers');
        });
        
        qTypesContainer.addEventListener('input', updateStep2Totals);
        [modeTopicBtn, modeClassBtn].forEach(btn => btn.addEventListener('click', (e) => setGenerationMode(e.target.id === 'modeTopicBtn' ? 'topic' : 'class')));
        schoolBoard.addEventListener('change', populateSubjects);
        classSelect.addEventListener('change', populateSubjects);
        subjectSelect.addEventListener('change', populateChapters);
        selectAllChaptersBtn.addEventListener('click', () => { chaptersContainer.querySelectorAll('.chapter-checkbox').forEach(cb => cb.checked = true); });
        deselectAllChaptersBtn.addEventListener('click', () => { chaptersContainer.querySelectorAll('.chapter-checkbox').forEach(cb => cb.checked = false); });
        
        document.getElementById('generatePaperBtn').addEventListener('click', () => {
             if (validateStep(currentStep)) {
                savePaper();
             }
        });

        darkModeToggle.addEventListener('change', () => {
            const theme = darkModeToggle.checked ? 'dark' : 'light';
            document.documentElement.setAttribute('data-bs-theme', theme);
            localStorage.setItem('darkMode', theme);
        });
        [langEnBtn, langHiBtn].forEach(btn => btn.addEventListener('click', (e) => switchLanguage(e.target.id === 'langEn' ? 'en' : 'hi')));

        // --- INITIALIZATION ---
        const savedTheme = localStorage.getItem('darkMode');
        if (savedTheme === 'dark') {
            darkModeToggle.checked = true;
            document.documentElement.setAttribute('data-bs-theme', 'dark');
        }
        
        populateClasses();
        injectQuestionTypes();
        showStep(0);
        setGenerationMode('class');
        switchLanguage('en'); // Default to English
        renderGeneratedPapers();
        updateStep2Totals();
        updateDistribution();
    });
  </script>
</body>
</html>
